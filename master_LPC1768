#include "mbed.h"
//master
/*slav側のanalogin(p20)から入手したセンサの値を受信し、PCのシリアルモニタに表示します。
一つのmbedに複数のセンサやモータをつなぐと、GNDを介して電流が他の機器に逆流してしまい？　
PWMの調子が狂うので、mbedを２台に分けて使おうと思いました。（GND作りをしても良かったが、回路設計面倒そうだったので・・・）
 参考元：https://os.mbed.com/questions/77669/UARTshort-int-mbedmbed/
 */
Serial pc(USBTX,USBRX);
Serial device(p9,p10);//スレーブにつないでいるTX,RX
DigitalOut Uart(p8);//ピン変化割り込みに使うピン
DigitalOut led(LED1);//オンボードのLED
Timer timer;
struct {
        char highbyte;
        char lowbyte;
        short intdat;
} data;
 
int read() //読み込む関数
{
    Uart = 1;//ピン変化割り込みするためにHIGHに
 
    while (device.readable() != 1);
    char c = device.getc();
    if(c != 'H') {
        Uart = 0;
        return 0;
    }
 
    while (device.readable() != 1);
    data.lowbyte = device.getc();
 
    while (device.readable() != 1);
    data.highbyte = device.getc();
 
    Uart = 0;//元に戻す
    
    data.intdat = data.highbyte*256+data.lowbyte;//復元
    pc.printf("Re %d\r\n",data.intdat);
    return 1;
}
 
int main() {
        device.baud(115200);//スレーブの通信速度
        wait_ms(100);
        while(1) {
                pc.printf("start\r\n");
                read();
                wait_ms(100);
        }
}
 
